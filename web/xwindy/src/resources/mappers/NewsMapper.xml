<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xwindy.web.mapper.NewsMapper">
	<!-- 资讯 -->
	<resultMap type="News" id="NewsResult">
		<id property="id" column="id" />
		<result property="publicId" column="public_id" />
		<result property="publicName" column="public_name" />
		<result property="publicIP" column="public_ip" />
		<result property="title" column="title" />
		<result property="content" column="content" />
		<result property="url" column="url_from" />
		<result property="datetime" column="datetime" />
		<result property="push" column="push" />
		<result property="clickNum" column="click" />
		<result property="commentNum" column="comment_number" />
	</resultMap>
	<select id="getNewsListByPage"
			resultMap="NewsResult">
			SELECT * FROM news
			ORDER BY id DESC
			<include refid="pageLimitSql" />
	</select>
	<select id="getNewsListByUserIdAndPage"
			resultMap="NewsResult">
			SELECT * FROM user_subscribe_news_view
			WHERE user_id = #{userId}
			ORDER BY id DESC
			<include refid="pageLimitSql" />
	</select>
	<select id="getNewsListByPublicIdAndPage"
			resultMap="NewsResult">
			SELECT * FROM news_and_public_view
			WHERE id = #{publicId}
			ORDER BY id DESC
			<include refid="pageLimitSql" />
	</select>
	<select id="getNewsById"
			parameterType="int"
			resultMap="NewsResult">
			SELECT * FROM news_and_public_view
			WHERE id = #{id}
	</select>
	<update id="addClickNumberById"
			parameterType="int">
			UPDATE news
			SET click = click + 1
			WHERE id = #{id} 
	</update>
	<insert id="addNews"
			parameterType="News">
			INSERT INTO news
				(public_id, public_ip, title, content, datetime, url_from, push)
			VALUES
				(#{publicId}, #{publicIP}, #{title}, #{content}, #{datetime}, #{url}, #{push})
	</insert>
	<update id="updateNews"
			parameterType="News">
			UPDATE news
			SET title = #{title}, content = #{content}, url_from = #{url}
			WHERE id = #{id}
	</update>
	<delete id="deleteNewsById"
			parameterType="int">
			DELETE FROM news
			WHERE id = #{id}
	</delete>
	
	<sql id="pageLimitSql">
		<if test="pageNo != null">
			LIMIT ${(pageNo * pageSize)}, ${pageSize}
		</if>
	</sql>
	
	<!-- 评论 -->
	<resultMap type="Comment" id="CommentResult">
		<id property="id" column="id"/>
		<result property="userId" column="user_id"/>
		<result property="username" column="username"/>
		<result property="newsId" column="news_id"/>
		<result property="userIP" column="user_ip"/>
		<result property="content" column="comment_content"/>
		<result property="datetime" column="datetime"/>
	</resultMap>
	<select id="getCommentById"
			resultMap="CommentResult">
			SELECT news_comment.*, plate_users.username
			FROM news_comment
			LEFT JOIN plate_users ON news_comment.user_id = plate_users.id
			WHERE news_comment.id = #{id}
	</select>
	<select id="getCommentListByNewsId"
			resultMap="CommentResult">
			SELECT news_comment.*, plate_users.username
			FROM news_comment
			LEFT JOIN plate_users ON news_comment.user_id = plate_users.id
			WHERE news_id = #{newsId}
	</select>
	
	<select id="getAllCommentList"
			resultMap="CommentResult">
			SELECT news_comment.*, plate_users.username
			FROM news_comment
			LEFT JOIN plate_users ON news_comment.user_id = plate_users.id
	</select>
	
	<insert id="addComment"
			parameterType="Comment"
			useGeneratedKeys="true"
    		keyProperty="id">
			INSERT INTO news_comment
			(user_id, news_id, user_ip, comment_content, datetime)
			VALUES
			(#{userId}, #{newsId}, #{userIP}, #{content} ,#{datetime})
	</insert>
	
	<delete id="deleteCommentById">
			DELETE FROM news_comment WHERE id = #{id}
	</delete>
	
	<select id="getCommentNumByNewsId"
			resultType="int">
			SELECT COUNT(0)
			FROM news_comment
			WHERE news_id = #{newsId}
	</select>
</mapper>